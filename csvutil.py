import csv
from datetime import datetime

################################################################
# abuse.ch URLhaus Database Dump (CSV)                         #
# Last updated: 2021-05-07 14:09:20 (UTC)                      #
#                                                              #
# Terms Of Use: https://urlhaus.abuse.ch/api/                  #
# For questions please contact urlhaus [at] abuse.ch           #
################################################################
#
# id,dateadded,url,url_status,threat,tags,urlhaus_link,reporter

# start line idx : 9

CSV_DATEADDED = 1
CSV_URL = 2
CSV_URL_STATUS = 3
CSV_URLHAUS_LINK = 6


class AliveURL:
    def __init__(self, url, urlhaus_link, date):
        self.MIRROR_URL = url
        self.URLHAUS_LINK = urlhaus_link
        self.DATE = date

def CsvGetAliveURL(csvfile):
    global CSV_URL, CSV_URL_STATUS, CSV_URLHAUS_LINK
    
    lines = csv.reader(csvfile)
    index = 0
    AliveURLlist  = []
    recentDate = datetime(2000,1,1,1,1)

    for line in lines:
        index += 1
        if index > 9:
            if line[CSV_URL_STATUS] == "online":
                AliveURLlist.append(AliveURL(line[CSV_URL], line[CSV_URLHAUS_LINK], line[CSV_DATEADDED]))
                date = datetime.strptime(line[CSV_DATEADDED], "%Y-%m-%d %H:%M:%S")
            if recentDate < date:
                recentDate = date
    
    return AliveURLlist, recentDate


def CsvUpdateURL(csvfile, urllist, predate):
    global CSV_URL, CSV_URL_STATUS, CSV_URLHAUS_LINK

    lines = csv.reader(csvfile)
    index = 0
    recentDate = datetime(2000,1,1,1,1)

    for line in lines:
        index += 1
        if index > 9:
            if line[CSV_URL_STATUS] == "online":
                date = datetime.strptime(line[CSV_DATEADDED], "%Y-%m-%d %H:%M:%S")

                if date > predate:
                    urllist.append(AliveURL(line[CSV_URL], line[CSV_URLHAUS_LINK], line[CSV_DATEADDED]))
                        if recentDate < date:
                            recentDate = datge
        if recentDate < predate:
            recentDate = predate

    return urllist, recentDate



def run():
    li, red = CsvGetAliveURL(open(".\\URLhausDatabase.\\database.csv", "r"))
    print(li, red)
if __name__ == '__main__':
    run()