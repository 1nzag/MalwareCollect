import json
import requests
import zipfile
import os, sys


def DownloadDatabase():
    result = True
    URLhauseDatabaseapi = "https://urlhaus.abuse.ch/downloads/csv/"
    with open(".\\URLhausDatabase\\recent.zip", "wb") as f:
        try:
            response = requests.get(URLhauseDatabaseapi, timeout = 15).content
            f.write(response)
        except:
            print("[!] Error: Download - request error")
            result = False
        try:
            with zipfile.ZipFile(".\\URLhausDatabase\\recent.zip", "r") as recent_zip:
                recent_zip.extract("csv.txt", ".\\URLhausDatabase\\recent")

                if os.path.isfile(".\\URLhausDatabase\\recent\\csv.txt"):
                    os.rename(".\\URLhausDatabase\\recent\\csv.txt", ".\\URLhausDatabase\\database.csv")
        except Exception as ex:
            print("[!] Error: zip - Database unzip error")
            print(ex)
            result = False
    
    if result == True:
        print("[+] database update with csv", flush=True)

    if os.path.isfile(".\\URLhausDatabase\\recent.zip"):
        os.remove(".\\URLhausDatabase\\recent.zip")
    
    if os.path.isdir(".\\URLhausDatabase\\recent"):
        if os.path.isfile(".\\URLhausDatabase\\recent\\csv.txt"):
            os.remove(".\\URLhausDatabase\\recent\\csv.txt")
        os.rmdir(".\\URLhausDatabase\\recent")

    return result


def run():
    DownloadDatabase()


if __name__ == '__main__':
    run()